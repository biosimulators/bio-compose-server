FROM ghcr.io/biosimulators/bio-compose-server-base:0.0.6-dev
# STABLE IS 0.0.2-dev and 0.0.3-dev

LABEL org.opencontainers.image.title="bio-compose-server-gateway" \
    org.opencontainers.image.description="Base Docker image for BioCompose REST API management, job processing, and datastorage with MongoDB, ensuring scalable and robust performance." \
    org.opencontainers.image.url="https://compose.biosimulators.org/" \
    org.opencontainers.image.source="https://github.com/biosimulators/bio-compose-server" \
    org.opencontainers.image.authors="Alexander Patrie <apatrie@uchc.edu>, BioSimulators Team <info@biosimulators.org>" \
    org.opencontainers.image.vendor="BioSimulators Team"

SHELL ["/usr/bin/env", "bash", "-c"]

COPY ./gateway /app/gateway
COPY ./shared /app/shared
COPY ./worker /app/worker

# RUN conda run -n server poetry config virtualenvs.create false \
#     && conda run -n server poetry lock \
#     && conda run -n server poetry install

RUN conda run -n server poetry config virtualenvs.create false \
    && conda run -n server poetry lock \
    && conda run -n server poetry install

# ENTRYPOINT ["/app/entrypoint.sh"]

CMD ["conda", "run", "-n", "server", "uvicorn", "gateway.main:app", "--port", "3001", "--host", "0.0.0.0", "--reload"]
